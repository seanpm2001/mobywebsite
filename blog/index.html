<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Moby Blog</title>
    <link rel="alternate" type="application/atom+xml" title="Blog" href="https://blog.mobyproject.org/feed" />
    <link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
    <link href="/css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700,800" rel="stylesheet">
    <link rel="stylesheet" href="/fonts/font-awesome-4.7.0/css/font-awesome.min.css">
  </head>

<body>
<nav class="primary-nav navbar navbar-toggleable-md fixed-top navbar-inverse navbar-expand-md">
    <!-- <div class="container"> -->
        <button class="toggle navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <i class="fa fa-bars" aria-hidden="true"></i>
            <!-- <i class="fa fa-caret-down" aria-hidden="true"></i> -->
        </button>
        <div class="brand">
            <a href="/">
  <svg id="62fd0a44-006e-4f0b-a15a-89faa84d6829" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 167.2 34.89"><title>moby</title><g id="b15aae01-8804-4f98-8c25-fdaeefa1406f" data-name="Page-1"><g id="3e77fe43-c191-4609-bd1f-fc92b641d8de" data-name="Artboard"><g id="db658e32-7de5-4695-8ac0-c1dafbc7f969" data-name="Group"><g id="1a13e8e5-cf70-4a93-aa29-e6bc1921be6a" data-name="Rectangle"><path d="M5.32,20.44A16.12,16.12,0,1,0,21.44,4.32,16.12,16.12,0,0,0,5.32,20.44ZM4,20.44A17.44,17.44,0,1,1,21.44,37.89,17.44,17.44,0,0,1,4,20.44Z" transform="translate(-4 -3)" style="fill:#fff"/></g><g id="5afc6b6f-2ffa-4176-9b5f-ab9c171c04c9" data-name="Combined-Shape"><path d="M18,36.68a52.79,52.79,0,0,0,3.1-6.28c3.13.09,9.9,0,13.29-6.56.09-.17.26-.52.87-1.81l.35-.69L33.69,20.2C31.6,18.82,26.74,18.3,23,19c-.43-3.54-2.43-6.56-6-9.33L15,8.28l-1.39,2.07a16.05,16.05,0,0,0-2.34,9.76,11.45,11.45,0,0,0,1.82,5.35A14.35,14.35,0,0,1,6.21,27,16.57,16.57,0,1,1,18,36.68Zm-4.07-1.44q-.73-.39-1.38-.79Q13.22,34.88,13.93,35.24Z" transform="translate(-4 -3)" style="fill:#fff"/></g></g><g id="0e76a8cc-554a-48a7-8f33-c1ca2fcc7436" data-name="Moby" style="isolation:isolate"><g style="isolation:isolate"><path d="M60.56,26.86l-3.08-8V28H54.2V14h4.44l3.48,8.86L65.62,14h4.44V28H66.78V18.82l-3.08,8Z" transform="translate(-4 -3)" style="fill:#fff"/><path d="M77.38,17.24a5.43,5.43,0,0,1,5.76,5.5,5.49,5.49,0,0,1-5.76,5.52,5.4,5.4,0,0,1-5.7-5.48A5.49,5.49,0,0,1,77.38,17.24Zm0,8.08a2.43,2.43,0,0,0,2.42-2.58,2.4,2.4,0,1,0-4.78,0A2.35,2.35,0,0,0,77.38,25.32Z" transform="translate(-4 -3)" style="fill:#fff"/><path d="M87.64,28H84.52V13.54h3.34V18.3a3.88,3.88,0,0,1,2.8-1.06c3,0,5,2.26,5,5.52s-2.12,5.5-5.14,5.5a4,4,0,0,1-2.84-1.08ZM90,25.34a2.29,2.29,0,0,0,2.26-2.56A2.32,2.32,0,0,0,90,20.18c-1.32,0-2.26.94-2.26,2.6A2.31,2.31,0,0,0,90,25.34Z" transform="translate(-4 -3)" style="fill:#fff"/><path d="M101.84,31.58H98.68l1.42-3.92L96.18,17.5h3.58l1.86,6,1.94-6H107Z" transform="translate(-4 -3)" style="fill:#fff"/></g></g><g id="cd464abf-e261-4a16-a9b5-77df6384f4d3" data-name="project" style="isolation:isolate"><g style="isolation:isolate"><path d="M111.5,17.62h1v1.92a4.41,4.41,0,0,1,3.86-2.18c3,0,5.06,2.26,5.06,5.42s-2,5.48-5,5.48a4.52,4.52,0,0,1-4-2.24v5.72h-1Zm4.94,9.7c2.26,0,3.94-1.88,3.94-4.54s-1.76-4.48-4-4.48c-2.42,0-3.94,2-3.94,4.48C112.46,25.66,114.28,27.32,116.44,27.32Z" transform="translate(-4 -3)" style="fill:#fff"/><path d="M127.88,18.34c-2.46,0-3.2,2-3.2,4.18V28h-1V17.62h1v1.86a3.31,3.31,0,0,1,3.2-2.12Z" transform="translate(-4 -3)" style="fill:#fff"/><path d="M134.2,17.36a5.26,5.26,0,0,1,5.32,5.44,5.33,5.33,0,1,1-10.66,0A5.25,5.25,0,0,1,134.2,17.36Zm0,10a4.26,4.26,0,0,0,4.3-4.52,4.3,4.3,0,1,0-8.58,0A4.25,4.25,0,0,0,134.18,27.32Z" transform="translate(-4 -3)" style="fill:#fff"/><path d="M141.76,17.62h1v10.8c0,2.58-1.32,3.38-2.86,3.38l-.48,0v-.9l.44,0c1.24,0,1.9-.74,1.9-2.46Zm.5-3.58a.82.82,0,1,1-.82.82A.81.81,0,0,1,142.26,14Z" transform="translate(-4 -3)" style="fill:#fff"/><path d="M150,17.36c3,0,4.88,2.22,4.88,5.2V23h-8.84a4,4,0,0,0,4.24,4.36,4.15,4.15,0,0,0,3.58-1.78l.66.46a4.75,4.75,0,0,1-4.24,2.24A5.12,5.12,0,0,1,145,22.84C145,19.44,147.38,17.36,150,17.36Zm3.84,4.74A3.71,3.71,0,0,0,150,18.28a3.85,3.85,0,0,0-3.88,3.82Z" transform="translate(-4 -3)" style="fill:#fff"/><path d="M165,19.82a4.61,4.61,0,0,0-3.42-1.52,4.24,4.24,0,0,0-4.14,4.5,4.34,4.34,0,0,0,4.16,4.52,4.63,4.63,0,0,0,3.46-1.6l.36.88a5.08,5.08,0,0,1-3.84,1.66,5.23,5.23,0,0,1-5.2-5.46,5.25,5.25,0,0,1,5.2-5.44,5.17,5.17,0,0,1,3.82,1.58Z" transform="translate(-4 -3)" style="fill:#fff"/><path d="M167.66,15.46h1v2.16h2.44v.9h-2.44v5.84c0,2.26.52,2.84,2.08,2.84l.46,0v.9s-.48,0-.86,0c-1.64,0-2.68-1-2.68-3.12V18.52h-1.28v-.9h1.28Z" transform="translate(-4 -3)" style="fill:#fff"/></g></g></g></g></svg>
 </a>

          </div>
        <div class="collapse navbar-collapse justify-content-end" id="navbarSupportedContent">
            <div class="justify-content-end">
                <ul class="navbar-nav mr-auto">
                    <ul class="navbar-nav mr-auto">
	<li class="nav-item nav-icon">
		<a  data-toggle="tooltip" data-toggle="tooltip" data-placement="bottom" title="check us out on GitHub" href="https://github.com/moby/moby#readme">
		<i class="fa fa-github" aria-hidden="true"></i></a>
	</li>
	<li>
		<a class="nav-item nav-icon"> 
		<a data-toggle="tooltip"  data-toggle="tooltip" data-placement="bottom" title="follow us on Twitter" href="https://twitter.com/moby"><i class="fa fa-twitter" aria-hidden="true"></i></a>
	</li>
	<li><a class="primary-nav-link nav-item" href="https://blog.mobyproject.org/">Blog</a></li>
	<li><a class="primary-nav-link nav-item" href="/community">Community</a></li>
	<li><a class="primary-nav-link nav-item" href="/projects">Projects</a></li>
	<li><a class="primary-nav-link" href="https://forums.mobyproject.org/" target="_blank">Forum</a></li>
</ul>

                </ul>
            </div>
        </div>
    <!-- </div> -->
</nav>
<div class="header-blog">
  <div class="banner-text">
    <h1>Blog</h1>
    <p>Updates and articles from various projects.</p>
  </div>
</div>
<div class="container">
  <div class="blog-content">
      

  
  
  
  

  
      
    <ul>
  

  <li class="posts"><span>15 Aug 2017</span> &raquo; <a href="/blog/2017/08/15/containerd-getting-started/">Getting Started with containerd</a><h1 id="getting-started-with-containerd">Getting started with containerd</h1>

<p>There are many different ways to use containerd.
If you are a developer working on containerd you can use the <code class="language-plaintext highlighter-rouge">ctr</code> tool to quickly test features and functionality without writing extra code.
However, if you want to integrate containerd into your project we have an easy to use client package that allows you to work with containerd.</p>

<p>In this guide we will pull and run a redis server with containerd using the client package.
We will assume that you are running a modern linux host for this example with a compatible build of <code class="language-plaintext highlighter-rouge">runc</code>.</p>

<h2 id="starting-containerd">Starting containerd</h2>

<p>You can download one of the latest builds for containerd on the <a href="https://github.com/containerd/containerd/releases">github releases</a> page and then use your favorite process supervisor to get the daemon started.
If you are using systemd, we have a <code class="language-plaintext highlighter-rouge">containerd.service</code> file at the root of the repository that you can use.</p>

<p>The daemon also uses a configuration file located in <code class="language-plaintext highlighter-rouge">/etc/containerd/config.toml</code> for specifying daemon level options.
A sample configuration file looks like this:</p>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="py">subreaper</span> <span class="p">=</span> <span class="kc">true</span>
<span class="py">oom_score</span> <span class="p">=</span> <span class="mi">-999</span>

<span class="nn">[debug]</span>
        <span class="py">level</span> <span class="p">=</span> <span class="s">"debug"</span>

<span class="nn">[metrics]</span>
        <span class="py">address</span> <span class="p">=</span> <span class="s">"127.0.0.1:1338"</span>

<span class="nn">[plugins.linux]</span>
        <span class="py">runtime</span> <span class="p">=</span> <span class="s">"runc"</span>
        <span class="py">shim_debug</span> <span class="p">=</span> <span class="kc">true</span>
</code></pre></div></div>

<p>The default configuration can be generated via <code class="language-plaintext highlighter-rouge">containerd config default &gt; /etc/containerd/config.toml</code>.</p>

<h2 id="connecting-to-containerd">Connecting to containerd</h2>

<p>We will start a new <code class="language-plaintext highlighter-rouge">main.go</code> file and import the containerd root package that contains the client.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"log"</span>

	<span class="s">"github.com/containerd/containerd"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">redisExample</span><span class="p">();</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">redisExample</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="n">client</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">containerd</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"/run/containerd/containerd.sock"</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="n">client</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>
	<span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This will create a new client with the default containerd socket path.
Because we are working with a daemon over GRPC we need to create a <code class="language-plaintext highlighter-rouge">context</code> for use with calls to client methods.
containerd is also namespaced for callers of the API.
We should also set a namespace for our guide after creating the context.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">ctx</span> <span class="o">:=</span> <span class="n">namespaces</span><span class="o">.</span><span class="n">WithNamespace</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Background</span><span class="p">(),</span> <span class="s">"example"</span><span class="p">)</span>
</code></pre></div></div>

<p>Having a namespace for our usage ensures that containers, images, and other resources without containerd do not conflict with other users of a single daemon.</p>

<h2 id="pulling-the-redis-image">Pulling the redis image</h2>

<p>Now that we have a client to work with we need to pull an image.
We can use the redis image based on alpine linux from the DockerHub.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">image</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">client</span><span class="o">.</span><span class="n">Pull</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="s">"docker.io/library/redis:alpine"</span><span class="p">,</span> <span class="n">containerd</span><span class="o">.</span><span class="n">WithPullUnpack</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>
</code></pre></div></div>

<p>The containerd client uses the <code class="language-plaintext highlighter-rouge">Opts</code> pattern for many of the method calls.
We use the <code class="language-plaintext highlighter-rouge">containerd.WithPullUnpack</code> so that we not only fetch and download the content into containerd’s content store but also unpack it into a snapshotter for use as a root filesystem.</p>

<h2 id="creating-an-oci-spec-and-container">Creating an OCI Spec and Container</h2>

<p>Now that we have an image to base our container off of, we need to generate an OCI runtime specification that the container can be based off of.</p>

<p>containerd provides reasonable defaults for generating OCI runtime specs.
There is also an <code class="language-plaintext highlighter-rouge">Opt</code> for modifying the default config based on the image that we pulled.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">spec</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">containerd</span><span class="o">.</span><span class="n">GenerateSpec</span><span class="p">(</span><span class="n">containerd</span><span class="o">.</span><span class="n">WithImageConfig</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">image</span><span class="p">))</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>
</code></pre></div></div>

<p>After we have a spec generated we need to create a container.
The container will be based off of the image, use the runtime information in the spec that was just created, and we will allocate a new read-write snapshot so the container can store any persistent information.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">container</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">client</span><span class="o">.</span><span class="n">NewContainer</span><span class="p">(</span>
		<span class="n">ctx</span><span class="p">,</span>
		<span class="s">"redis-server"</span><span class="p">,</span>
		<span class="n">containerd</span><span class="o">.</span><span class="n">WithSpec</span><span class="p">(</span><span class="n">spec</span><span class="p">),</span>
		<span class="n">containerd</span><span class="o">.</span><span class="n">WithImage</span><span class="p">(</span><span class="n">image</span><span class="p">),</span>
		<span class="n">containerd</span><span class="o">.</span><span class="n">WithNewSnapshot</span><span class="p">(</span><span class="s">"redis-server-snapshot"</span><span class="p">,</span> <span class="n">image</span><span class="p">),</span>
	<span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="n">container</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">containerd</span><span class="o">.</span><span class="n">WithSnapshotCleanup</span><span class="p">)</span>
</code></pre></div></div>

<p>When creating a new snapshot for the container we need to provide a snapshot ID as well as the Image that the container will be based on.
By providing a separate snapshot ID than the container ID we can easily reuse, existing snapshots across different containers.</p>

<p>We also add a line to delete the container along with its snapshot after we are done with this example.</p>

<h2 id="creating-a-running-task">Creating a running Task</h2>

<p>One thing that may be confusing at first for new containerd users is the separation between a <code class="language-plaintext highlighter-rouge">Container</code> and a <code class="language-plaintext highlighter-rouge">Task</code>.
A container is a metadata object that resources are allocated and attached to.
A task is a live, running process on the system.
Tasks should be deleted after each run while a container can be used, updated, and queried multiple times.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">task</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">container</span><span class="o">.</span><span class="n">NewTask</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">containerd</span><span class="o">.</span><span class="n">Stdio</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="n">task</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
</code></pre></div></div>

<p>The new task that we just created is actually a running process on your system.
We use the <code class="language-plaintext highlighter-rouge">containerd.Stdio</code> <code class="language-plaintext highlighter-rouge">Opt</code> so that all IO from the container is sent to our <code class="language-plaintext highlighter-rouge">main.go</code> process.</p>

<p>If you are familiar with the OCI runtime actions, the task is currently in the “created” state.
This means that the namespaces, root filesystem, and various container level settings have been initialized but the user defined process, in this example “redis-server”, has not been started.
This gives users a chance to setup network interfaces or attach different tools to monitor the container.
containerd also takes this opportunity to monitor your container as well.
Waiting on things like the container’s exit status and cgroup metrics are setup at this point.</p>

<p>If you are familiar with prometheus you can curl the containerd metrics endpoint (in the <code class="language-plaintext highlighter-rouge">config.toml</code> that we created) to see your container’s metrics:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> curl 127.0.0.1:1228/metrics
</code></pre></div></div>

<p>Pretty cool right?</p>

<h2 id="task-wait-and-start">Task Wait and Start</h2>

<p>Now that we have a task in the created state we need to make sure we that we wait on the task to exit so that we can close our example and cleanup the resources that we created.
You always want to make sure you <code class="language-plaintext highlighter-rouge">Wait</code> before calling <code class="language-plaintext highlighter-rouge">Start</code> on a task.
This makes sure that you do not encounter any races if the task has a simple program like <code class="language-plaintext highlighter-rouge">/bin/true</code> that exits promptly after calling start.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">exitStatusC</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">uint32</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
	<span class="k">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="n">status</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">task</span><span class="o">.</span><span class="n">Wait</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="n">exitStatusC</span> <span class="o">&lt;-</span> <span class="n">status</span>
	<span class="p">}()</span>

	<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">task</span><span class="o">.</span><span class="n">Start</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>
</code></pre></div></div>

<p>Now we should see the <code class="language-plaintext highlighter-rouge">redis-server</code> logs in our terminal when we run the <code class="language-plaintext highlighter-rouge">main.go</code> file.</p>

<h2 id="killing-the-task">Killing the task</h2>

<p>Since we are running a long running server we will need to kill the task in order to exit out of our example.
To do this we will simply call <code class="language-plaintext highlighter-rouge">Kill</code> on the task after waiting a couple of seconds so we have a chance to see the redis-server logs.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">3</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>

	<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">task</span><span class="o">.</span><span class="n">Kill</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">syscall</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">exitStatusC</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"redis-server exited with status: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>
</code></pre></div></div>

<p>We wait on our exit status channel that we setup to ensure the task has fully exited and we get the exit status.
If you have to reload containers or miss waiting on a task, <code class="language-plaintext highlighter-rouge">Delete</code> will also return the exit status when you finally delete the task.
We got you covered.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">status</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">task</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="full-example">Full Example</h2>

<p>Here is the full example that we just put together.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"context"</span>
	<span class="s">"fmt"</span>
	<span class="s">"log"</span>
	<span class="s">"syscall"</span>
	<span class="s">"time"</span>

	<span class="s">"github.com/containerd/containerd"</span>
	<span class="s">"github.com/containerd/containerd/namespaces"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">redisExample</span><span class="p">();</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">redisExample</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="c">// create a new client connected to the default socket path for containerd</span>
	<span class="n">client</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">containerd</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"/run/containerd/containerd.sock"</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="n">client</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span>

	<span class="c">// create a new context with an "example" namespace</span>
	<span class="n">ctx</span> <span class="o">:=</span> <span class="n">namespaces</span><span class="o">.</span><span class="n">WithNamespace</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Background</span><span class="p">(),</span> <span class="s">"example"</span><span class="p">)</span>

	<span class="c">// pull the redis image from DockerHub</span>
	<span class="n">image</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">client</span><span class="o">.</span><span class="n">Pull</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="s">"docker.io/library/redis:alpine"</span><span class="p">,</span> <span class="n">containerd</span><span class="o">.</span><span class="n">WithPullUnpack</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>

	<span class="c">// generate an OCI runtime spec using the Args, Env, etc from the redis image that we pulled</span>
	<span class="n">spec</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">containerd</span><span class="o">.</span><span class="n">GenerateSpec</span><span class="p">(</span><span class="n">containerd</span><span class="o">.</span><span class="n">WithImageConfig</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">image</span><span class="p">))</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>

	<span class="c">// create a container</span>
	<span class="n">container</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">client</span><span class="o">.</span><span class="n">NewContainer</span><span class="p">(</span>
		<span class="n">ctx</span><span class="p">,</span>
		<span class="s">"redis-server"</span><span class="p">,</span>
		<span class="n">containerd</span><span class="o">.</span><span class="n">WithSpec</span><span class="p">(</span><span class="n">spec</span><span class="p">),</span>
		<span class="n">containerd</span><span class="o">.</span><span class="n">WithImage</span><span class="p">(</span><span class="n">image</span><span class="p">),</span>
		<span class="n">containerd</span><span class="o">.</span><span class="n">WithNewSnapshot</span><span class="p">(</span><span class="s">"redis-server-snapshot"</span><span class="p">,</span> <span class="n">image</span><span class="p">),</span>
	<span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="n">container</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">containerd</span><span class="o">.</span><span class="n">WithSnapshotCleanup</span><span class="p">)</span>

	<span class="c">// create a task from the container</span>
	<span class="n">task</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">container</span><span class="o">.</span><span class="n">NewTask</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">containerd</span><span class="o">.</span><span class="n">Stdio</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>
	<span class="k">defer</span> <span class="n">task</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

	<span class="c">// make sure we wait before calling start</span>
	<span class="n">exitStatusC</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">uint32</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
	<span class="k">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
		<span class="n">status</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">task</span><span class="o">.</span><span class="n">Wait</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="n">exitStatusC</span> <span class="o">&lt;-</span> <span class="n">status</span>
	<span class="p">}()</span>

	<span class="c">// call start on the task to execute the redis server</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">task</span><span class="o">.</span><span class="n">Start</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>

	<span class="c">// sleep for a lil bit to see the logs</span>
	<span class="n">time</span><span class="o">.</span><span class="n">Sleep</span><span class="p">(</span><span class="m">3</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>

	<span class="c">// kill the process and get the exit status</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">task</span><span class="o">.</span><span class="n">Kill</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">syscall</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">err</span>
	<span class="p">}</span>

	<span class="c">// wait for the process to fully exit and print out the exit status</span>

	<span class="n">status</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">exitStatusC</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"redis-server exited with status: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>

	<span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We can build this example and run it as follows to see our hard work come together.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> go build <span class="nt">-o</span> example main.go
<span class="o">&gt;</span> <span class="nb">sudo</span> ./example

1:C 04 Aug 20:41:37.682 <span class="c"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span>
1:C 04 Aug 20:41:37.682 <span class="c"># Redis version=4.0.1, bits=64, commit=00000000, modified=0, pid=1, just started</span>
1:C 04 Aug 20:41:37.682 <span class="c"># Warning: no config file specified, using the default config. In order to specify a config file use redis-server /path/to/redis.conf</span>
1:M 04 Aug 20:41:37.682 <span class="c"># You requested maxclients of 10000 requiring at least 10032 max file descriptors.</span>
1:M 04 Aug 20:41:37.682 <span class="c"># Server can't set maximum open files to 10032 because of OS error: Operation not permitted.</span>
1:M 04 Aug 20:41:37.682 <span class="c"># Current maximum open files is 1024. maxclients has been reduced to 992 to compensate for low ulimit. If you need higher maxclients increase 'ulimit -n'.</span>
1:M 04 Aug 20:41:37.683 <span class="k">*</span> Running <span class="nv">mode</span><span class="o">=</span>standalone, <span class="nv">port</span><span class="o">=</span>6379.
1:M 04 Aug 20:41:37.683 <span class="c"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span>
1:M 04 Aug 20:41:37.684 <span class="c"># Server initialized</span>
1:M 04 Aug 20:41:37.684 <span class="c"># WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.</span>
1:M 04 Aug 20:41:37.684 <span class="c"># WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.</span>
1:M 04 Aug 20:41:37.684 <span class="k">*</span> Ready to accept connections
1:signal-handler <span class="o">(</span>1501879300<span class="o">)</span> Received SIGTERM scheduling shutdown...
1:M 04 Aug 20:41:40.791 <span class="c"># User requested shutdown...</span>
1:M 04 Aug 20:41:40.791 <span class="k">*</span> Saving the final RDB snapshot before exiting.
1:M 04 Aug 20:41:40.794 <span class="k">*</span> DB saved on disk
1:M 04 Aug 20:41:40.794 <span class="c"># Redis is now ready to exit, bye bye...</span>
redis-server exited with status: 0
</code></pre></div></div>

<p>In the end, we really did not write that much code when you use the client package.</p>

<p>I hope this guide helped to get you up and running with containerd.
Feel free to join the <a href="https://dockr.ly/community">slack channel</a> if you have any questions and like all things, if you want to help contribute to containerd or this guide, submit a pull request.</p>
</li>

  
        
      
        </ul>
          
        <ul>
      
    
  

  
  
  
  

  

  <li class="posts"><span>26 Jun 2017</span> &raquo; <a href="/blog/2017/06/26/sign-all-the-things/">Sign all the things!</a><h2 id="notary--linuxkit-deep-dive">Notary + LinuxKit deep dive</h2>

<p>Just a few months ago, we open sourced <a href="https://github.com/linuxkit/linuxkit">LinuxKit</a>, a toolkit to build secure, lean, and portable Linux subsystems. One of the key features of LinuxKit lies in its componentization: each of its individual components, including its kernel and system services, are completely swappable.</p>
</li>

  
        
      
    
  

  
  
  
  

  

  <li class="posts"><span>26 Jun 2017</span> &raquo; <a href="/blog/2017/06/26/moby-summit-recap/">Moby Summit June 2017 Recap</a><h3 id="moby-summit-at-docker-headquarter">Moby Summit at Docker headquarter</h3>

<p><img src="/images/moby-summit.jpg" alt="Moby Summit Intro" title="Moby Summit Intro" /></p>

<p>On June 19 2017, 90 members of the Moby community gathered at Docker headquarter in San Francisco for the second Moby Summit.  This was an opportunity for the community to discuss the progress and future of the Moby project, two months after it was announced.</p>

<p>We started the day with an introduction by Solomon Hykes, and a look at the website redesign: the <a href="http://mobyproject.org/">Moby project website</a> now has a <a href="http://mobyproject.org/blog/">blog</a>, an event calendar, a list of projects, and a <a href="http://mobyproject.org/community/">community page</a> with links to various community resources. The <a href="https://github.com/moby/mobywebsite">website code is open source</a>, issues and PRs to write guest blog posts or enhance it are welcome.</p>

<p>Then each team gave an update on their progress: Linuxkit, containerd, InfraKit, SwarmKit and LibNetwork, as well as the three new <a href="http://mobyproject.org/projects/">Moby Special Interest Groups</a>, Linuxkit Security, Security Scanning &amp; Notary and Orchestration Security. All these talks have been recorded and you can find the videos and slides below.</p>

<p>In the afternoon, we split into 5 Birds Of Feathers (BOF) sessions: runc/containerd, LinuxKit, InfraKit, Security, and Security Scanning. You can find links to the BOF Notes at the end of this post.</p>

<p>We ended the day with a recap of the BOF sessions, and some beer.</p>

<h3 id="moby-summit-introduction">Moby Summit Introduction</h3>

<iframe width="560" height="315" src="https://www.youtube.com/embed/Bkm9RFeQ-qI" frameborder="0" allowfullscreen=""></iframe>

<p>Slides: <a href="https://www.slideshare.net/chanezon/moby-introduction-june-2017">Moby Summit Introduction</a></p>

<h3 id="linuxkit-update">LinuxKit Update</h3>

<iframe width="560" height="315" src="https://www.youtube.com/embed/ByfegHVbJk0" frameborder="0" allowfullscreen=""></iframe>

<p>Slides: <a href="https://www.slideshare.net/Docker/linuxkit-update-at-the-moby-summit">LinuxKit update</a></p>

<h3 id="containerd-update">containerd Update</h3>

<iframe width="560" height="315" src="https://www.youtube.com/embed/sSyb7776YXY" frameborder="0" allowfullscreen=""></iframe>

<h3 id="infrakit-update">InfraKit Update</h3>

<iframe width="560" height="315" src="https://www.youtube.com/embed/a83zyeWPkYw" frameborder="0" allowfullscreen=""></iframe>

<p>Slides: <a href="http://www.slideshare.net/Docker/infrakit-update-at-moby-summit-june-2017">Infrakit update</a></p>

<h3 id="swarmkit-update">SwarmKit update</h3>

<iframe width="560" height="315" src="https://www.youtube.com/embed/LXvn2MNX1I8" frameborder="0" allowfullscreen=""></iframe>

<p><a href="https://github.com/dperny/swarm-proxy">Swarm Proxy</a> is a program for managing Docker Swarm services behind a reverse proxy. It uses the Docker events stream to monitor for services being created and removed, and then uses Swarm Configs to update a reverse proxy service to correctly route traffic to those services. It is stateless.</p>

<h3 id="libnetwork-update">Libnetwork update</h3>

<iframe width="560" height="315" src="https://www.youtube.com/embed/rcdbGnty1n0" frameborder="0" allowfullscreen=""></iframe>

<p>Slides: <a href="http://www.slideshare.net/Docker/libnetwork-update-at-moby-summit-june-2017">Libnetwork update</a></p>

<h3 id="security-update">Security Update</h3>

<p>Finally, the Docker security team gave the update on the following topics:</p>
<ul>
  <li>LinuxKit security update</li>
  <li>Security scanning and Notary update</li>
  <li>Orchestration security update</li>
</ul>

<iframe width="560" height="315" src="https://www.youtube.com/embed/EvGOfTJ_nEo" frameborder="0" allowfullscreen=""></iframe>

<p>Slides: <a href="https://www.slideshare.net/Docker/llinuxkit-security-security-scanning-and-notary">LinuxKit Security and container container scanning with Notary</a></p>

<p>Slides: <a href="https://www.slideshare.net/diogomonica/moby-sig-orchestration-security-summit-presentation">Orchestration security</a></p>

<h3 id="bof-summary-notes">BOF Summary Notes</h3>
<ul>
  <li><a href="https://github.com/containerd/containerd/blob/master/reports/2017-06-23.md">runC / containerd</a></li>
  <li><a href="https://github.com/linuxkit/linuxkit/blob/master/reports/2017-06-19-summit.md">LinuxKit</a></li>
  <li><a href="https://forums.mobyproject.org/t/2017-06-19-meeing-notes/79">Security Scanning &amp; Notary</a></li>
  <li><a href="https://forums.mobyproject.org/t/2017-06-19-orchestration-security-sig-meeting/90">Orchestration Security</a></li>
</ul>

<p><a href="https://twitter.com/share?text=+Check+out+videos+and+slides+from+the+last+Moby+Summit+%23containerd+%23linuxkit+%23infrakit+&amp;via=moby&amp;related=moby&amp;url=https://mobyproject.org/blog/2017/06/26/moby-summit-recap/">Tweet “Check out the videos &amp; slides from the last @moby Summit #containerd #linuxkit #infrakit “</a></p>

</li>

  
        
      
        </ul>
          
        <ul>
      
    
  

  
  
  
  

  

  <li class="posts"><span>11 May 2017</span> &raquo; <a href="/blog/2017/05/11/moby-summit-report/">Moby Summit at DockerCon 2017-05-11</a><h2 id="moby-summit-videos-from-dockercon">Moby Summit videos from DockerCon</h2>

<p>Last month at DockerCon, Solomon introduced the <a href="https://blog.docker.com/2017/04/introducing-the-moby-project/">Moby Project: a new open-source project to advance the software containerization movement</a>. The idea behind the project is to help the ecosystem take containers mainstream by providing a library of components, a framework for assembling them into custom container-based systems and a place for all container enthusiasts to experiment and exchange ideas.</p>
</li>

  
        
      
    
  

  
  
  
  

  

  <li class="posts"><span>08 May 2017</span> &raquo; <a href="/blog/2017/05/08/moby-dev-report/">Moby Dev Report 2017-05-08</a><h2 id="daily-meeting">Daily Meeting</h2>

<p>A daily meeting is hosted on <a href="https://dockercommunity.slack.com">slack</a> every business day at 9am PST on the channel <code class="language-plaintext highlighter-rouge">#moby-project</code>.
During this meeting, we are talking about the <a href="https://github.com/moby/moby/issues/32867">tasks</a> needed to be done for splitting moby and docker.</p>
</li>

  
        
      
    
  

  
  
  
  

  

  <li class="posts"><span>08 May 2017</span> &raquo; <a href="/blog/2017/05/08/moby-builder-report/">Moby Builder Report 2017-05-08</a><h2 id="quality-dependency-interface-switch">Quality: Dependency interface switch</h2>

<p>Proposal for <a href="https://github.com/moby/moby/issues/32904">switching the dependency interface</a> for current builder package. That should fix the current problems with data leakage and conflicts caused by daemon state cleanup scripts.</p>
</li>

  
        
      
    
  

  
  
  
  

  

  <li class="posts"><span>01 May 2017</span> &raquo; <a href="/blog/2017/05/01/moby-dev-report/">Moby Dev Report 2017-05-01</a><h2 id="moby-dev-report">Moby Dev Report</h2>

<p>This is the 1st report, since the Moby project was announced at DockerCon. Thank you to everyone that stayed an extra day to attend the summit on Thursday.</p>
</li>

  
        
      
    
  

  
  
  
  

  

  <li class="posts"><span>01 May 2017</span> &raquo; <a href="/blog/2017/05/01/moby-builder-report/">Moby Builder Report 2017-05-01</a><h2 id="buildkit">buildkit</h2>

<p>As part of the goals of <a href="https://github.com/moby/moby#transitioning-to-moby">Moby</a> to split the current platform into reusable components and to provide a future vision for the builder component new <a href="https://github.com/moby/moby/issues/32925">buildkit proposal</a> was opened with early design draft.</p>
</li>

  
    </ul>
  



  </div>
</div>
<footer class="footer">
    <div class="container">
        <div class="copyright">
            Copyright © 2023, Moby Project
        </div>
        <div class="footer-links">
            <ul class="navbar-nav mr-auto justify-content-end">
	<li class="nav-item nav-icon">
		<a  data-toggle="tooltip" data-toggle="tooltip" data-placement="top" title="check us out on GitHub" href="https://github.com/moby/moby#readme">
		<i class="fa fa-github" aria-hidden="true"></i></a>
	</li>

	<li>
		<a class="nav-item nav-icon"> 
		<a data-toggle="tooltip"  data-toggle="tooltip" data-placement="top" title="follow us on Twitter" href="https://twitter.com/moby"><i class="fa fa-twitter" aria-hidden="true"></i></a>
	</li>
	<li>
		<a class="nav-item nav-icon"> 
		<a data-toggle="tooltip" data-toggle="tooltip" data-placement="top" title="YouTube" href="https://www.youtube.com/playlist?list=PLkA60AVN3hh_eRYZIlUEYQFNN69iulTAk"><i class="fa fa-youtube" aria-hidden="true"></i></a>
	</li>
	<li>
		<a class="nav-item nav-icon"> 
		<a data-toggle="tooltip"  data-toggle="tooltip" data-placement="top" title="RSS Feed" href="https://blog.mobyproject.org/feed" target="_blank"><i class="fa fa-rss" aria-hidden="true"></i></a>
	</li>
	<li><a href="https://blog.mobyproject.org/">Blog</a></li>
	<li><a href="/community">Community</a></li>
	<li><a href="/projects">Projects</a></li>
</ul>

        </div>
    </div>
</footer>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
<script src="/js/tether.min.js"></script>
<script src="/js/main.js"></script>
<script>
    (function(i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function() {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');
    
    ga('create', 'UA-6096819-28', 'auto');
    ga('send', 'pageview');
</script>
</body>
</html>

